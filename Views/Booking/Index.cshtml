@model BookingViewModel
@{
    ViewData["Title"] = "Bookinger";
}

<div class="booking-header">
    <h1>üè¢ Rombooking</h1>

    <div class="date-selector">
        <a asp-action="Index"
           asp-route-date="@Model.SelectedDate.AddDays(-1).ToString("yyyy-MM-dd")"
           class="btn btn-secondary btn-sm">‚Äπ Forrige</a>

        <span class="current-date">@Model.SelectedDate.ToString("dddd, dd. MMMM yyyy")</span>

        <a asp-action="Index"
           asp-route-date="@Model.SelectedDate.AddDays(1).ToString("yyyy-MM-dd")"
           class="btn btn-secondary btn-sm">Neste ‚Ä∫</a>

        <form asp-action="Index" method="get" style="display:inline-flex; align-items:center; gap:8px;">
            <input type="date"
                   name="date"
                   value="@Model.SelectedDate.ToString("yyyy-MM-dd")"
                   class="form-control"
                   style="width:auto; padding:0.5rem;"
                   onchange="this.form.submit()" />
        </form>
    </div>

    <a asp-action="Index"
       asp-route-date="@DateTime.Today.ToString("yyyy-MM-dd")"
       class="btn">I dag</a>
</div>

@if (Model.Rooms.Any())
{
    <div class="booking-calendar">
        @{
            var openingTime = new TimeSpan(8, 0, 0);
            var closingTime = new TimeSpan(16, 0, 0);
            var timeSlots = new List<TimeSpan>();

            for (var t = openingTime; t < closingTime; t = t.Add(TimeSpan.FromMinutes(30)))
                timeSlots.Add(t);

            var roomsToShow = Model.Rooms.ToList();
            var skipUntil = roomsToShow.ToDictionary(r => r.Id, r => DateTime.MinValue);
        }

        <!-- Header -->
        <div class="calendar-header"
             style="display:grid; grid-template-columns: 90px repeat(@roomsToShow.Count, minmax(220px, 1fr)); gap:10px; align-items:end; margin-bottom:10px;">

            <div class="time-col"></div>

            @foreach (var room in roomsToShow)
            {
                <div class="room-card" style="padding:12px;">
                    <h3>@room.Name</h3>
                    @if (!string.IsNullOrEmpty(room.Description))
                    {
                        <p class="room-description">@room.Description</p>
                    }
                </div>
            }
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid"
             style="display:grid; grid-template-columns: 90px repeat(@roomsToShow.Count, minmax(220px, 1fr)); gap:10px;">

            @for (int r = 0; r < timeSlots.Count; r++)
            {
                var slot = timeSlots[r];
                var slotStart = Model.SelectedDate.Date.Add(slot);
                var gridRow = r + 1;

                <div class="time-col" style="grid-column:1; grid-row:@gridRow;">
                    @slot.ToString(@"hh\:mm")
                </div>

                @for (int i = 0; i < roomsToShow.Count; i++)
                {
                    var room = roomsToShow[i];
                    var gridCol = i + 2;

                    if (skipUntil[room.Id] > slotStart)
                        continue;

                    var bookings = Model.RoomBookings.ContainsKey(room.Id)
                    ? Model.RoomBookings[room.Id]
                    : new List<Booking>();

                    var booking = bookings.FirstOrDefault(b => b.StartTime <= slotStart && b.EndTime > slotStart);

                    if (booking != null && booking.StartTime == slotStart)
                    {
                        var durationMinutes = (booking.EndTime - booking.StartTime).TotalMinutes;
                        var rowSpan = Math.Max(1, (int)(durationMinutes / 30));
                        skipUntil[room.Id] = booking.EndTime;

                        <div class="time-slot booked"
                             style="grid-column:@gridCol; grid-row:@gridRow / span @rowSpan;">
                            <span class="time">@booking.StartTime.ToString("HH:mm") - @booking.EndTime.ToString("HH:mm")</span>
                            <span class="user">@booking.User.FullName</span>
                            @if (!string.IsNullOrEmpty(booking.Notes))
                            {
                                <span class="notes">@booking.Notes</span>
                            }
                        </div>
                    }
                    else if (booking == null)
                    {
                        <a asp-action="Create"
                           asp-route-roomId="@room.Id"
                           asp-route-date="@Model.SelectedDate.ToString("yyyy-MM-dd")"
                           asp-route-time="@slot.ToString(@"hh\:mm")"
                           class="time-slot available"
                           style="grid-column:@gridCol; grid-row:@gridRow;">
                            <span class="status">‚úì Ledig</span>
                        </a>
                    }
                }
            }
        </div>
    </div>
}
else
{
    <div class="empty-state">
        <p>üì≠ Ingen rom tilgjengelig. Kontakt administrator.</p>
        <a asp-controller="Rooms" asp-action="Index" class="btn">Administrer rom</a>
    </div>
}